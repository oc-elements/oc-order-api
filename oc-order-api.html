<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">


<dom-module id="oc-order-api">
	<template>
		<iron-ajax id="findOrder"></iron-ajax>
		<iron-ajax id="getOrder"></iron-ajax>
		<iron-ajax id="getOrders"></iron-ajax>
		<iron-ajax id="searchOrder"></iron-ajax>
		<iron-ajax id="getOrdersByOrganisation"></iron-ajax>
		<iron-ajax id="getDeliveryCost"></iron-ajax>
		<iron-ajax id="payForOrder"></iron-ajax>
		<iron-ajax id="payOrder"></iron-ajax>
		<iron-ajax id="getOrderStatusses"></iron-ajax>
		<iron-ajax id="createGrn"></iron-ajax>
		<iron-ajax id="getEstimateDeliveryCost"></iron-ajax>
		<iron-ajax id="pendingOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="cancelOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="acceptOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="readyOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="collectOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="deliverOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="rejectOrder" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="inTransit" method="put" content-type="application/json"></iron-ajax>
		<iron-ajax id="assignDeliveryAgent" method="put"></iron-ajax>
	</template>

	<script>

		class OcOrderApi extends Ordercloud.ApiMixin(Polymer.Element) {
			static get is() {
				return 'oc-order-api';
			}

			static get properties() {
				return {};
			}

			payOrder(fromAccountId, orderId) {
				const params = {
					body: JSON.stringify({
						fromAccountId,
						orderId
					})
				}


				this.$.payOrder.url = this._generateUrl('transactions/order-payment');
				this.$.payOrder.body = {
					fromAccountId,
					orderId
				};
				this.$.payOrder.method = "POST";
				this.$.payOrder.contentType = "application/json";
				return this._generateRequest(this.$.payOrder);
			}


			findOrder(ref) {
				this.$.findOrder.url = this._generateUrl('orders/find/' + ref);
				return this._generateRequest(this.$.findOrder);
			}

			/**
			 * Get order.
			 * @param {Number} id The order ID
			 * @returns {Promise}
			 */
			getOrder(id) {
				this.$.getOrder.url = this._generateUrl('orders/' + id);
				return this._generateRequest(this.$.getOrder);
			}

			/**
			 * Returns all the orders for the organisation.
			 * @param {{
         *  page: Number (default 1),
         *  pageSize: Number (default 20),
         *  orderStatuses: Number[],
         *  paymentStatuses: String[],
         *  sort: String (default 'date+'),
         *  fromDate: String,
         *  toDate: String,
         * }} criteria
			 * @returns {Promise}
			 */
			getOrders(criteria) {
				this.$.getOrders.url = this._generateUrl('orders');
				this.$.getOrders.params = {
					'page': (criteria.page === null || criteria.page === undefined) ? 0 : criteria.page,
					'pagesize': criteria.pageSize || 20,
					'orderstatus': criteria.orderStatuses || [],
					'paymentstatus': criteria.paymentStatuses || [],
					'sort': criteria.sort || 'date+',
					'fromDate': criteria.fromDate || [],
					'toDate': criteria.toDate || []
				};
				return this._generateRequest(this.$.getOrders);
			}

			/* Search for a specific order by id */
			searchOrder(orderId) {
				this.$.searchOrder.url = this._generateUrl('orders/' + orderId);
				this.$.searchOrder.method = 'GET';
				return this._generateRequest(this.$.searchOrder);
			}
			/* get estimate delivery cost
			GET /orders/organisation/{organisationId}/delivery/address/{locationId}
			*/
			getEstimateDeliveryCost(organisationId, locationId) {
				this.$.getEstimateDeliveryCost.url = this._generateUrl('orders/organisation/' + organisationId + '/delivery/address/' + locationId);
				this.$.getEstimateDeliveryCost.method = 'GET';
				return this._generateRequest(this.$.getEstimateDeliveryCost);
			}

			/* Fetch Orders by Organisation Id */
			getOrdersByOrganisation(orgId, criteria) {
				this.$.getOrdersByOrganisation.url = this._generateUrl(`orders/organisation/${orgId}`);
				this.$.getOrdersByOrganisation.params = {
					'page': (!criteria.page) ? -1 : criteria.page,
					'pagesize': criteria.pageSize || 20,
					'orderstatus': criteria.orderStatuses || [],
					'paymentstatus': criteria.paymentStatuses || [],
					'sort': criteria.sort || 'date-',
					'fromDate': criteria.fromDate || [],
					'toDate': criteria.toDate || []
				};
				return this._generateRequest(this.$.getOrdersByOrganisation);
			}

			getDeliveryCost(marketplaceId, organisationId, geoId) {
				this.$.getDeliveryCost.url = this.getDeliveryCost(`orders/organisation/${marketplaceId}/delivery/geo/${geoId}`);
				this.$.getDeliveryCost.body = [
					{
						id: organisationId
					}
				];
				return this._generateRequest(this.$.getDeliveryCost);
			}

			pendingOrder(orderId) {
				this.$.pendingOrder.url = this._generateUrl('orders/' + orderId + '/status/pending');
				return this._generateRequest(this.$.pendingOrder);
			}

			cancelOrder(orderId) {
				this.$.cancelOrder.url = this._generateUrl('orders/' + orderId + '/status/canceled');
				return this._generateRequest(this.$.cancelOrder);
			}

			/**
			 * Accept the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation accepting the order
			 * @param {Number} estReadyTime In minutes
			 * @param {String} message
			 * @returns {Promise}
			 */
			acceptOrder(id, organisationId, estReadyTime, message) {
				this.$.acceptOrder.url = this._generateUrl('orders/' + id + '/organisation/' + organisationId + '/status/accept');
				this.$.acceptOrder.body = {
					message: message || '',
					estimatedReadyTime: estReadyTime || 0
				};
				return this._generateRequest(this.$.acceptOrder);
			}

			/**
			 * Ready the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation readying the order
			 * @param {String} message
			 * @returns {Promise}
			 */
			readyOrder(id, organisationId, message) {
				this.$.readyOrder.url = this._generateUrl('orders/' + id + '/organisation/' + organisationId + '/status/ready');
				this.$.readyOrder.body = { message: message || '' };
				return this._generateRequest(this.$.readyOrder);
			}

			/**
			 * Collect the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation collecting the order
			 * @param {String} message
			 * @returns {Promise}
			 */
			collectOrder(id, organisationId, message) {
				this.$.collectOrder.url = this._generateUrl('orders/' + id + '/organisation/' + organisationId + '/status/collected');
				this.$.collectOrder.body = { message: message || '' };
				return this._generateRequest(this.$.collectOrder);
			}

			/**
			 * Deliver the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation delivering the order
			 * @param {String} message
			 * @returns {Promise}
			 */
			deliverOrder(id) {
				this.$.deliverOrder.url = this._generateUrl('orders/' + id + '/status/delivered');
				return this._generateRequest(this.$.deliverOrder);
			}

			/**
			 * Reject the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation rejecting the order
			 * @param {String} message
			 * @returns {Promise}
			 */
			rejectOrder(id, organisationId, message) {
				this.$.rejectOrder.url = this._generateUrl('orders/' + id + '/organisation/' + organisationId + '/status/declined');
				this.$.rejectOrder.body = { message: message || '' };
				return this._generateRequest(this.$.rejectOrder);
			}

			/* Set order in transit. Its next status will be delivered*/
			inTransit(id, organisationId, message) {
				this.$.inTransit.url = this._generateUrl('orders/' + id + '/organisation/' + organisationId + '/status/in_transit');
				this.$.inTransit.body = { message: message || '' };
				return this._generateRequest(this.$.inTransit);
			}

			/**
			 * Self pickup the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} organisationId The ID of the organisation self pickuping the order
			 * @param {String} message
			 * @returns {Promise}
			 */
			payForOrder(id, accountId) {
				this.$.payForOrder.url = this._generateUrl('orders/' + id + '/pay/account/' + accountId);
				this.$.payForOrder.method = "POST";
				this.$.payForOrder.contentType = "application/json";
				return this._generateRequest(this.$.payForOrder);
			}

			/**
			 * Assign a delivery agent to the order
			 * @param {Number} id The ID of the order to accept
			 * @param {Number} deliveryAgentId The ID of the delivery agent to assign to the order
			 * @returns {Promise}
			 */
			assignDeliveryAgent(id, deliveryAgentId) {
				this.$.assignDeliveryAgent.url = this._generateUrl('orders/' + id + '/agent/' + deliveryAgentId);
				return this._generateRequest(this.$.assignDeliveryAgent);
			}

			/**
			 * Get lookup of order statusses
			 * @returns {Promise}
			 */
			getOrderStatusses() {
				this.$.getOrderStatusses.url = this._generateUrl('orderstatus');
				return this._generateRequest(this.$.getOrderStatusses);
			}

			/* Create grn for an order */
			createGrn(orderId, grn) {
				this.$.createGrn.url = this._generateUrl(`orders/${orderId}/grn`);
				this.$.createGrn.method = "PUT";
				this.$.createGrn.contentType = "application/json";
				this.$.createGrn.body = { grn: grn || '' };
				return this._generateRequest(this.$.createGrn);
			}

		}

		window.customElements.define(OcOrderApi.is, OcOrderApi);
	</script>
</dom-module>
